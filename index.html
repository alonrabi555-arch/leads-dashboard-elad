<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>××§×“××™×™×ª ××œ×¢×“ ×¨×‘×™ â€” ×œ×™×“×™×</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #0f1117; color: #e5e7eb; }
    .badge-hot    { background:#16a34a22; color:#4ade80; border:1px solid #16a34a; }
    .badge-avg    { background:#ca8a0422; color:#fbbf24; border:1px solid #ca8a04; }
    .badge-weak   { background:#71717a22; color:#a1a1aa; border:1px solid #52525b; }
    .badge-disq   { background:#dc262622; color:#f87171; border:1px solid #dc2626; }
    .badge-exp    { background:#7c3aed22; color:#a78bfa; border:1px solid #7c3aed; }
    .stat-card    { background:#1a1d27; border:1px solid #2d3148; }
    table         { border-collapse: collapse; width: 100%; }
    th            { background:#1a1d27; color:#9ca3af; font-size:0.75rem; letter-spacing:0.05em; text-transform:uppercase; padding:12px 16px; text-align:right; }
    td            { padding:12px 16px; border-bottom:1px solid #1f2333; font-size:0.875rem; }
    tr:hover td   { background:#1a1d2788; }
    .filter-btn          { background:#1a1d27; border:1px solid #2d3148; color:#9ca3af; padding:6px 16px; border-radius:9999px; cursor:pointer; transition:all .2s; font-size:0.85rem; }
    .filter-btn.active   { background:#4f46e5; border-color:#4f46e5; color:#fff; }
    .filter-btn:hover:not(.active) { border-color:#4f46e5; color:#a5b4fc; }
    #refresh-btn { background:#1a1d27; border:1px solid #2d3148; color:#9ca3af; padding:6px 14px; border-radius:8px; cursor:pointer; font-size:0.8rem; }
    #refresh-btn:hover { border-color:#4f46e5; color:#a5b4fc; }
    .loading { color:#6b7280; text-align:center; padding:60px 0; }
    .stage-pill { background:#1f2333; color:#6b7280; font-size:0.7rem; padding:2px 8px; border-radius:9999px; }

    /* Status dropdown */
    .status-select {
      background: #1a1d27; border: 1px solid #2d3148; color: #6b7280;
      padding: 4px 8px; border-radius: 8px; font-size: 0.78rem;
      cursor: pointer; outline: none; transition: all .2s; min-width: 130px;
    }
    .status-select:hover { border-color: #4f46e5; }
    .s-called       { border-color:#3b82f6 !important; color:#60a5fa !important; background:#3b82f611 !important; }
    .s-thinking     { border-color:#f97316 !important; color:#fb923c !important; background:#f9731611 !important; }
    .s-bought       { border-color:#22c55e !important; color:#4ade80 !important; background:#22c55e11 !important; }
    .s-not_relevant { border-color:#6b7280 !important; color:#9ca3af !important; background:#6b728011 !important; }

    .logo-img { height: 48px; width: auto; object-fit: contain; }
  </style>
</head>
<body class="min-h-screen p-6">

  <!-- ===== CONFIGURE THESE TWO LINES ===== -->
  <script>
    const SUPABASE_URL  = 'https://vjjqnxbevdimgulqvain.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqanFueGJldmRpbWd1bHF2YWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODAzMjQsImV4cCI6MjA4NzE1NjMyNH0.PQmB0alaLnG83FwLhwOalIxTN1bbY0llpmSBw88GTp0';
  </script>
  <!-- ======================================= -->

  <div class="max-w-7xl mx-auto">

    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center gap-4">
        <img src="×œ×•×’×• - × ×¢×¨×š.png"
             alt="×œ×•×’×• ××§×“××™×™×ª ××œ×¢×“ ×¨×‘×™" class="logo-img"
             onerror="this.style.display='none'">
        <div>
          <h1 class="text-2xl font-bold text-white">âœ‚ï¸ ××§×“××™×™×ª ××œ×¢×“ ×¨×‘×™</h1>
          <p class="text-sm text-gray-500 mt-1">×“×©×‘×•×¨×“ ×œ×™×“×™× â€” ×¢×“×›×•×Ÿ ××—×¨×•×Ÿ: <span id="last-updated">â€”</span></p>
        </div>
      </div>
      <button id="refresh-btn" onclick="loadLeads()">âŸ³ ×¨×¢× ×Ÿ</button>
    </div>

    <!-- Stats Row -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8" id="stats-row">
      <div class="stat-card rounded-xl p-4 text-center">
        <div class="text-3xl font-bold text-white" id="stat-total">â€”</div>
        <div class="text-xs text-gray-500 mt-1">×¡×”"×› ×œ×™×“×™×</div>
      </div>
      <div class="stat-card rounded-xl p-4 text-center">
        <div class="text-3xl font-bold text-green-400" id="stat-hot">â€”</div>
        <div class="text-xs text-gray-500 mt-1">ğŸ”¥ ×—×</div>
      </div>
      <div class="stat-card rounded-xl p-4 text-center">
        <div class="text-3xl font-bold text-yellow-400" id="stat-avg">â€”</div>
        <div class="text-xs text-gray-500 mt-1">â­ ×××•×¦×¢</div>
      </div>
      <div class="stat-card rounded-xl p-4 text-center">
        <div class="text-3xl font-bold text-zinc-400" id="stat-weak">â€”</div>
        <div class="text-xs text-gray-500 mt-1">â„ï¸ ×—×œ×©</div>
      </div>
      <div class="stat-card rounded-xl p-4 text-center">
        <div class="text-3xl font-bold text-violet-400" id="stat-exp">â€”</div>
        <div class="text-xs text-gray-500 mt-1">âœ‚ï¸ ×× ×•×¡×”</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap gap-2 mb-5">
      <button class="filter-btn active" onclick="setFilter('all', this)">×”×›×œ</button>
      <button class="filter-btn" onclick="setFilter('hot', this)">ğŸ”¥ ×—×</button>
      <button class="filter-btn" onclick="setFilter('average', this)">â­ ×××•×¦×¢</button>
      <button class="filter-btn" onclick="setFilter('weak', this)">â„ï¸ ×—×œ×©</button>
      <button class="filter-btn" onclick="setFilter('disqualified', this)">ğŸš« ×¤×¡×•×œ</button>
      <button class="filter-btn" onclick="setFilter('experienced', this)">âœ‚ï¸ ×× ×•×¡×”</button>
    </div>

    <!-- Table -->
    <div class="rounded-xl overflow-hidden border border-[#2d3148]">
      <div id="table-container">
        <div class="loading">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
      </div>
    </div>

    <p class="text-xs text-gray-600 mt-4 text-center">××ª×¨×¢× ×Ÿ ××•×˜×•××˜×™×ª ×›×œ 60 ×©× ×™×•×ª</p>
  </div>

  <script>
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON);

    let allLeads = [];
    let currentFilter = 'all';

    const stageLabel = s => {
      if (s === -1) return '×¤×¡×•×œ';
      if (s === 9)  return '×”×•×©×œ×';
      return `×©××œ×” ${s + 1}`;
    };

    const categoryBadge = cat => {
      if (!cat) return `<span class="badge-weak stage-pill">×‘×ª×”×œ×™×š</span>`;
      const map = {
        hot:          `<span class="badge-hot rounded-full px-3 py-0.5 text-xs font-semibold">ğŸ”¥ ×—×</span>`,
        average:      `<span class="badge-avg rounded-full px-3 py-0.5 text-xs font-semibold">â­ ×××•×¦×¢</span>`,
        weak:         `<span class="badge-weak rounded-full px-3 py-0.5 text-xs font-semibold">â„ï¸ ×—×œ×©</span>`,
        disqualified: `<span class="badge-disq rounded-full px-3 py-0.5 text-xs font-semibold">ğŸš« ×¤×¡×•×œ</span>`,
      };
      return map[cat] || `<span class="badge-weak stage-pill">${cat}</span>`;
    };

    const statusClass = s => ({
      called:       's-called',
      thinking:     's-thinking',
      bought:       's-bought',
      not_relevant: 's-not_relevant',
    })[s] || '';

    async function updateStatus(id, value) {
      const { error } = await db
        .from('leads')
        .update({ crm_status: value || null })
        .eq('id', id);
      if (error) { console.error('Status update error:', error.message); return; }
      const lead = allLeads.find(l => l.id === id);
      if (lead) lead.crm_status = value || null;
      const sel = document.querySelector(`select[data-id="${id}"]`);
      if (sel) sel.className = 'status-select ' + statusClass(value);
    }

    const fmtDate = iso => {
      if (!iso) return 'â€”';
      const d = new Date(iso);
      return d.toLocaleDateString('he-IL', { day:'2-digit', month:'2-digit', year:'2-digit',
        hour:'2-digit', minute:'2-digit' });
    };

    const fmtPhone = p => p ? p.replace('+972', '0') : 'â€”';

    const preferredCallLabel = v => ({ zoom:'×–×•× ğŸ’ª', phone:'×˜×œ×¤×•×Ÿ ğŸ“' })[v] || v || 'â€”';
    const hoursLabel = v => ({ morning:'×‘×•×§×¨', afternoon:'×¦×”×¨×™×™×', evening:'×¢×¨×‘' })[v] || v || 'â€”';

    async function loadLeads() {
      try {
        const { data, error } = await db
          .from('leads')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;
        allLeads = data || [];
        updateStats();
        renderTable();
        document.getElementById('last-updated').textContent =
          new Date().toLocaleTimeString('he-IL');
      } catch (e) {
        document.getElementById('table-container').innerHTML =
          `<div class="loading text-red-400">×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×: ${e.message}</div>`;
      }
    }

    function updateStats() {
      const t = allLeads.length;
      const hot  = allLeads.filter(l => l.lead_category === 'hot').length;
      const avg  = allLeads.filter(l => l.lead_category === 'average').length;
      const weak = allLeads.filter(l => l.lead_category === 'weak').length;
      const exp  = allLeads.filter(l => l.is_experienced).length;
      document.getElementById('stat-total').textContent = t;
      document.getElementById('stat-hot').textContent   = hot;
      document.getElementById('stat-avg').textContent   = avg;
      document.getElementById('stat-weak').textContent  = weak;
      document.getElementById('stat-exp').textContent   = exp;
    }

    function setFilter(f, btn) {
      currentFilter = f;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderTable();
    }

    function getFiltered() {
      if (currentFilter === 'all')         return allLeads;
      if (currentFilter === 'experienced') return allLeads.filter(l => l.is_experienced);
      return allLeads.filter(l => l.lead_category === currentFilter);
    }

    function renderTable() {
      const leads = getFiltered();
      if (!leads.length) {
        document.getElementById('table-container').innerHTML =
          `<div class="loading">××™×Ÿ ×œ×™×“×™× ×œ×”×¦×’×”</div>`;
        return;
      }

      const rows = leads.map(l => `
        <tr>
          <td class="font-medium text-white">${l.name || 'â€”'}</td>
          <td class="font-mono text-gray-400">${fmtPhone(l.phone)}</td>
          <td class="text-center">
            <span class="font-bold text-lg ${
              (l.score >= 16) ? 'text-green-400' :
              (l.score >= 10) ? 'text-yellow-400' : 'text-zinc-400'
            }">${l.score !== null ? Number(l.score).toFixed(1) : 'â€”'}</span>
          </td>
          <td>${categoryBadge(l.lead_category)}
            ${l.is_experienced ? ' <span class="badge-exp rounded-full px-2 py-0.5 text-xs">âœ‚ï¸</span>' : ''}
          </td>
          <td class="text-center">
            <span class="stage-pill">${stageLabel(l.stage)}</span>
          </td>
          <td class="text-gray-500">${preferredCallLabel(l.preferred_call)}</td>
          <td class="text-gray-500">${hoursLabel(l.avail_hours)}</td>
          <td>
            <select class="status-select ${statusClass(l.crm_status)}"
                    data-id="${l.id}"
                    onchange="updateStatus('${l.id}', this.value)">
              <option value="">â€” ×¡×˜×˜×•×¡ â€”</option>
              <option value="called"       ${l.crm_status === 'called'       ? 'selected' : ''}>ğŸ“ ×”×ª×§×©×¨×ª×™</option>
              <option value="thinking"     ${l.crm_status === 'thinking'     ? 'selected' : ''}>ğŸ’­ ×¢×“×™×™×Ÿ ×—×•×©×‘</option>
              <option value="bought"       ${l.crm_status === 'bought'       ? 'selected' : ''}>âœ… ×§× ×”</option>
              <option value="not_relevant" ${l.crm_status === 'not_relevant' ? 'selected' : ''}>âŒ ×œ× ×¨×œ×•×•× ×˜×™</option>
            </select>
          </td>
          <td class="text-gray-600 text-xs">${fmtDate(l.created_at)}</td>
        </tr>
      `).join('');

      document.getElementById('table-container').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>×©×</th>
              <th>×˜×œ×¤×•×Ÿ</th>
              <th class="text-center">× ×™×§×•×“</th>
              <th>×§×˜×’×•×¨×™×”</th>
              <th class="text-center">×©×œ×‘</th>
              <th>×¡×•×’ ×©×™×—×”</th>
              <th>×–××™× ×•×ª</th>
              <th>×¡×˜×˜×•×¡</th>
              <th>× ×•×¦×¨</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    // Initial load + auto-refresh every 60s
    loadLeads();
    setInterval(loadLeads, 60000);
  </script>
</body>
</html>
